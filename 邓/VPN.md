vpn原理简述

一、安全原理

1.加密算法（确保数据是安全的）

- 加密算法概述
  明文---------->密文
  对称加密算法 vs 非对称加密算法
- 对称加密算法（一般用于真正的数据交换）
  算法：DES、3DES 、AES、RC4
  （社工库）
  原理：
  特征：
  1. 紧凑性：加密前后文件大小变化不大
     1. 速度快
        1. 安全性高
     2. 密钥管理难
        1. 不支持数字签名
        2. 不支持不可否认性
- 非对称加密算法（一般用于密钥交换）
  算法：RSA、DH、ECC
  原理：
  	密钥串：公钥+私钥，私钥加密公钥解，公钥加密私钥解，要将数据包发给谁就用谁的公钥
  特征：
  1. 不可否认性
  2. 支持数字签名
  3. 支持密钥分发
- 对称 + 非对称
  对称算法用于加密数据（采用对称密钥加密）
  非对称算法用于密码交换（交换对称密钥）
  

2.哈希算法（解决数据包没有被篡改）

- 哈希算法（hash）分类
  MD5、SHA
- 哈希算法原理
  特征：
  1. 雪崩效应：如果明文有任何修改，hash全局改变
  2. 不可逆向：无法根据hash值得到明文
  3. 固定输出：128bit、160bit（Cain & Able可解密简单的密码）
  功能：
  1. 完整性校验
  2. 安全性校验
- 哈希算法的应用
  网盘秒传
  软件下载（安全验证）
  

3.密钥化散列

- 密钥化散列原理及功能
  发送方：对明文和共享密钥进行hash计算，得出的HMAC值放在报文后面
  接收方：分离明文，对明文和本地密钥hash计算，比较其HMAC值
  功能：用于实现完整性校验
             实现身份认证
  

4.数字签名（此数据一定是私钥持有者发送的）

- 数字签名组件
  HASH算法
  非对称加密算法
- 数字签名原理
  简述：发送方经过私钥加密的hash值
  发送方：
  1. 签名者对明文进行hash计算
  2. 签名者用本地私钥对hash出来的散列值加密
  3. 加密后的散列值放在密文尾部一起发送出去
  接收方：
  1. 用签名者的公钥解开加密的散列值
  2. 用明文的散列和刚用公钥解开的散列进行对比
- 数字签名功能
  不可抵赖性：
  	用签名者的公钥可以解开HMAC证明数据是签名者发送的
  数据完整性：
  	HASH值相同证明明文没有被篡改
  

5.数字证书（PKI架构）

- 数字证书组成
  -                    CA(公钥+名字+地址+有效期)
    	                		|
                         			|
                  | ----------------->数字证书---------------------> |
                  |                                                                  |
    密文+加密密钥+数字签名---------->密文+加密密钥+数字签名+数字证书
  - 对等公钥
  - 对等姓名、组织、地址
  - 证书有效期
  - CA的数字签名
- 数字证书原理
  发送方：
  1. 向CA组注册，涉及内容包括：姓名、地址、公钥、数字签名、证书有效期
  2. 向CA获取数字证书，并添加在密文后面
  第三方 CA：
  1. 对对等体的信息进行数字签名-用CA的私钥加密用户信息
  接收方：
  1. 向CA获取公钥，用公钥解开CA的数字签名，对比hash值
  2. 用证书夹带的公钥解开发送者的数字签名，对比hash值
- PKI架构
  CA：发证书
  RA：做注册
  数字证书
  对等体（发送方于接收方）
  分发机制
  

二、进阶

1.VPN概念

- SSL VPN（淘宝时数据加密）
- IPsec VPN（最官方应用于企业级）
- PPTP L2TP(翻墙用)

2.IPsec原理

- 背景：
  1. 传统专线价格比较高
  2. IPsec VPN基于加密线路传输
  3. 部署非常方便，客户既能够上网又能于分支相互通信
  4. IPsec VPN在企业网络/校园网络分支之间使用
- 基于IPsec：
  L2L-VPN
  DRE over IPsec
  EzVPN
  DMVPN
  HA-VPN
  VPN Combination
- IPsec定义：
  网络层用使用加密传输机制的IETF标准
- IPsec组成：
  协议：IKE、ESP、AH
  算法：
  	对称加密：DES/3DES/AES
  	非对称加密：DH
  	hash：MD5/AH
  |----------------------------------------------|
  |                |  算法  |                          |
  |                |----------|                         |
  |                                     协议           |
  |----------------------------------------------|
  e.g. ESP   ---> DES
                   --->3DES
                   --->MD5
                   ---> ...
- 特征：机密性、完整性、不可抵赖性、身份认证<预共享密钥、数字证书、一次密码OPT、生物识别>
  

3.IKE原理(两条隧道的建立)

- 全称：Internet Key Exchange （互联网密钥交换）
- 功能：建立隧道 ---> 身份认证
                            ---> 密钥交换<管理>
                            ---> 参数协商
- IKE组成
  ISAKMP<隧道建立&分组结构&密钥交换>：定义消息交换的体系结构，包括两个IPsec对等体间，分组形式和状态转变(2个阶段，9个分组)
  SKEME：提供为认证目的使用公开密钥加密的机制
  OAKLEY：提供在两个IPsec对等体间达成相同加密密钥的基本模式的机制
- ISAKMP概述
  应用层协议，基于UDP 500 端口
- ISAKMP原理
  通过ISAKMP实现IPsec VPN的建立：
  	阶段一：6个分组<主模式>
  			ISKMAP SA隧道建立
  			1、2：隧道双方交换策略集
  			3、4：隧道双方实现DH密钥交换
  			5、6：隧道双方实现身份认证
  	阶段二：3个分组<快速模式>
  			IPsec SA隧道建立
  			7、8：转换集交换和感兴趣流交换
  			9：隧道正式建立

4.ESP详解

- ESP概述
  全称：Encapsulation Security Payload, 封装安全净荷
  功能：加密、数据检验
- ESP原理
  - 传输模式：
                          源IP头部 + 数据
    ----ESP------> 源IP头部 + ESP头部 + 加密数据
    （仅加密数据部分）
  - 隧道模式（主流）：
                          源IP头部 + 数据
    ----ESP------> 新IP头部 + ESP头部 + 加密数据
    （加密源IP头部和数据部分）

5.AH详解(逐渐没用，因为只做验证不加密)

- AH概述
  全称：Authentication Header, 认证头部
  功能：检验 < MD5/SHA >

三、高级

- IPsec VPN:
  L2L VPN(site to site VPN)
  GRE over IPsec
  EzVPN
  DMVPN
  HA

1. L2L VPN

- 概述：
  加密双方地址是固定的，拓扑结构一般比较简单

2.NAT-T

1. 背景：
   NAT Traversal, NAT穿透，用于实现私网IP——>公网IP VPN的建立
   思考问题：
   1. 双方公私地址是否能相互指定，或怎么找到对方？
   2. 私网VPN设备对数据进行加密，将端口信息加密了，NAT设备是否有问题？
2. PPPOE
   1. 宽带接入：
      - 老技术：ADSL（DSL），基于电信固定电话网络< POTS/PSTN >
      - 新技术：光纤接入，基于EPON和GPON
   2. PPPOE技术
      PPP over Ethernet
      用于在宽带接入网络中实现用户认证接入，不管在老的DSL技术还是新的光纤接入技术中都可以实现

3.SSL VPN

1. SSL的概述
   Secure Socket Layer，安全套接层，SSL/TLS主要用于电子商务、线上交易
2. SSL功能
   - 数据加密
   - 数据完整性检验
   - ps: 基于传输层（不同于IPsec基于网络层，可以做到更为细化的处理）
   HTTPS ≈ SSL ≈ web VPN
3. 应用场景
   - 移动办公
   - 合作伙伴
4. SSL 协议
   - 记录协议（record protocol）：用于实现数据加密（数据分析、压缩、哈希、加密）
   - 握手协议（handshake protocol）：用于实现隧道建立（版本、算法、数字证书认证、密钥交换）
   - 应用协议：提供应用层协议的协商，提供数据包格式
5. SSL 隧道协商
   - 第一阶段：握手阶段
   - 第二阶段：数据安全传输阶段
   - 过程简述：
     一阶段：
          （协商加密集）
     1. Client Hello(3DES\SHA\MD5) --->
     2. <--- Server Hello（客户端验证服务端）
        （客户端验证服务端）
     3. <--- Certification
        （共享密钥）
     4. RSA Key Exchange --->
     5. <--- RSA Key Exchange
        （完成）
     6. Established
     二阶段：
     - SSL 加密数据 --->
     - <--- SSL 加密数据
6. OpenSSL
   提供将ftp--->ftps的功能
   漏洞：心脏出血
